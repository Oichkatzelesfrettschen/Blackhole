# Repository Guidelines

## Architecture Overview
The renderer is a C++23 + OpenGL 4.6 pipeline with fragment and compute raytracing paths.

```
Input -> Camera/Basis -> Raytrace (frag/comp) -> Bloom -> Tonemap -> Depth Cues -> Present
                      -> LUTs (emissivity/redshift) -> Validation assets
```

## Core Structures & Patterns
- `RenderToTextureInfo` (`src/render.h`) configures passes (shader path, uniform maps, target, size); `PostProcessPass` (`src/main.cpp`) wraps post passes.
- `renderToTexture()` caches framebuffers; uniform maps avoid hardcoded bindings; `SettingsManager` persists to `settings.json`.

## Project Structure & Module Organization
- `src/`: runtime (`src/main.cpp`, `src/input.*`, `src/render.*`, `src/shader.*`) and `src/physics/` for Schwarzschild/Kerr and LUT helpers.
- `shader/`: GLSL 460 (`.frag/.vert/.comp`) plus `shader/include/`.
- `assets/`: `assets/luts/` and `assets/validation/` generated by scripts/tests.
- `bench/`, `docs/`, `scripts/`: perf harness, design notes, LUT/validation generators.

## Build, Test, and Development Commands
- `conan remote update conancenter --url="https://center2.conan.io"`
- `conan install . --output-folder=build --build=missing -s build_type=Release -s compiler.cppstd=23`
- `cmake --preset release` then `cmake --build --preset release`
- Optional Z3 tooling: `cmake --preset release -DENABLE_Z3=ON` then `cmake --build --preset release --target z3_sanity`
- Optional RmlUi overlay: `cmake --preset release -DENABLE_RMLUI=ON`
- Optional Tracy profiling: `cmake --preset release -DENABLE_TRACY=ON`
- `cmake --build --preset release --target validate-shaders`
- `./build/build/Release/Blackhole`, `./build/build/Release/physics_test`, `./build/build/Release/physics_bench`
- GPU bench: `./build/build/Release/physics_bench --gpu --gpu-width 256 --gpu-height 256 --gpu-iterations 20`
- `./build/build/Release/nubhlight_inspect -i dump_00000000.h5 -o logs/perf/nubhlight_meta.json`
- `./build/build/Release/nubhlight_pack -i dump_00000000.h5 -d /dump/P --fields RHO,UU,U1,U2 -o logs/perf/nubhlight_pack.json`
- `ctest --test-dir build/build/Release -R grmhd_pack_fixture --output-on-failure`
- `python3 scripts/generate_tardis_lut_stub.py --output-dir assets/luts`
- Static analysis: `cmake --preset analyze` and `cmake --build --preset analyze`

## Coding Style & Naming Conventions
- C++23, 2-space indent, braces on same line, CamelCase types, lowerCamelCase vars.
- GLSL: `#version 460` first line; includes via `GL_GOOGLE_include_directive`.
- Keep third-party files isolated; prefer upstream replacements to manual edits.

## Shader Architecture & Controls
- `shader/blackhole_main.frag`: simplex noise disk, quaternion camera, Schwarzschild geodesics; compute path in `shader/geodesic_trace.comp`.
- Key uniforms: `cameraPos`/`cameraBasis`, lensing toggle, disk params, `bloomStrength`/`gamma`, depth cues (`depthFar`, `fogStart/End`, `depthCurve`, `dofEnabled`).
- Controls: RMB orbit, MMB roll, scroll zoom; WASD/QE + Z/C + +/-; gamepad sticks/triggers; tweak in ImGui.

## Dependencies, CI, and Progress Tracking
- Conan deps: `imgui/1.92.5-docking`, `imguizmo/cci.20231114`, `rmlui/4.4`, `glfw/3.4`, `glbinding/3.5.0`, `glm/cci.20230113`, `xsimd/13.2.0`, `entt/3.15.0`, `pcg-cpp/cci.20220409`, `taskflow/3.10.0`, `flatbuffers/25.9.23`, `hdf5/1.14.6`, `highfive/3.1.1`, `spdlog/1.16.0`, `fmt/12.1.0`, `tracy/0.12.2`, `cli11/2.6.0`, `boost/1.90.0`, `stb/cci.20240531`, `z3/4.14.1` (optional).
- ImPlot is vendored from upstream (`external/implot`); fetch/update with `scripts/fetch_implot.sh` (Conan 0.16 incompatible with ImGui 1.92+).
- RmlUi is optional; `ENABLE_RMLUI` toggles a stub overlay for the MangoHUD port.
- GitHub Actions builds Release on push/PR (Conan + OpenGL dev libs).
- Canonical status: `STATUS.md`; active issues: `TODO_FIXES.md`; roadmap: `docs/ROADMAP_NEXT_PHASE.md` plus cleanroom plans in `docs/`.

## Testing, Validation, and PRs
- `physics_test` is the regression suite; add `TestResult` entries with tolerances as needed.
- `validate-shaders` required after shader edits (warnings fatal only with `-DENABLE_WERROR=ON`).
- Commits: short imperative or conventional prefixes (`feat:`, `docs:`, `chore:`); PRs include summary, tests, and screenshots for visual changes.

## Configuration & Performance Notes
- `settings.json` is written at runtime; keep settings backward compatible.
- For performance work, capture results in `bench/` and document thresholds.
